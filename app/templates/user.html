<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link rel="shortcut icon" href="assets/images/favicon.ico">

    <link href="assets/plugins/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/plugins/datatables/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/plugins/datatables/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/plugins/datatables/select.bootstrap4.min.css" rel="stylesheet" type="text/css" />

    <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/icons.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/style.css" rel="stylesheet" type="text/css" />
    <link href="css/util.css" rel="stylesheet" type="text/css" />

    <link href="assets/plugins/sweet-alert/sweetalert2.min.css" rel="stylesheet" type="text/css" />

    <script src="assets/js/modernizr.min.js"></script>

</head>

<body>
    <div class="container-fluid no-gutters w-100">
        <div class="row" style="height: 60px; border-bottom: 1px dotted darkgray; background-color: #1C2139;" id="divTop">
            <div class=col-sm-12>
                <div class="row">
                    <div class="col-sm-2">
                        <div class="logo">
                            <img src="images/logoDataMigra.png" alt="Data migra" style="height: 50px;" />
                            &nbsp;&nbsp;<label style="font-size: 13pt; color: white;">Data Migra - Painel</label>
                        </div>                
                    </div>
                    <div class="col-sm-8"></div>
                    <div class="col-sm-2">
                        <div class="btn-group pull-right m-t-20">
                            <button type="button" class="btn btn-custom btn-rounded dropdown-toggle waves-effect waves-light" data-toggle="dropdown" aria-expanded="false">
                                Configurações </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a href="#" onclick="abre('/panel');" class="dropdown-item">Painel</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-sm-12">
            <div class="btn-group pull-right m-t-20">
                <span>
                    <button type="button" class="btn btn-purple waves-effect waves-light m-b-5 btn-rounded"
                            onclick="renovar();">
                        Atualizar
                    </button>
                </span>
                &nbsp;&nbsp;
                <span>
                    <button type="button" class="btn btn-purple waves-effect waves-light m-b-5 btn-rounded"
                            onclick="novo();">
                        Novo
                    </button>
                </span>
            </div>
        </div>
        <br />
        <table id="tbUsuario" class="table table-bordered" cellspacing="0" style="width: 100%;
            background-color: white;">
            <thead>
                <tr>
                    <th style="width: 10%;">ID Usuário</th>
                    <th style="width: 35%;">Nome</th>
                    <th style="width: 30%;">E-mail</th>
                    <th style="width: 10%;">Tipo</th>
                    <th style="width: 15%;">Ativo(a)</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
        </table>

        <div id="divForm" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog"
             aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none; top: 150px;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background-color: #EBEFF2;">
                    <div class="modal-header">
                        <h4 class="modal-title mt-0" id="myLargeModalLabel">Usuário</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="form1" action="#" data-parsley-validate novalidate>
                            <div class="form-group">
                                <label>Nome do usuário*</label>
                                <input type="text" parsley-trigger="change" required maxlength="60"
                                       placeholder="Nome do usuário" class="form-control" id="TXT_NOME_USUARIO">
                            </div>
                            <div class="form-group">
                                <label>E-mail*</label>
                                <input parsley-trigger="change" type="email" maxlength="80"
                                       placeholder="E-mail do usuário"
                                       class="form-control" id="TXT_EMAIL_USUARIO" />
                            </div>
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 30%;">
                                        <div class="form-group">
                                            <label>Senha*</label>
                                            <input type="password" required maxlength="20"
                                                   placeholder="Senha do usuário" class="form-control" id="TXT_SENHA_USUARIO" />
                                        </div>
                                    </td>
                                    <td style="width: 30%;">
                                        <div class="form-group">
                                            <label>Usuário Ativo*</label>
                                            <select parsley-trigger="change" required type="date"
                                                    class="form-control" id="CB_USUARIO_ATIVO">
                                                <option value="0">Não</option>
                                                <option value="1" selected>Sim</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td style="width: 30%;">
                                        <div class="form-group">
                                            <label>Tipo do usuário*</label>
                                            <select parsley-trigger="change" required type="date"
                                                    class="form-control" id="CB_TIPO_USUARIO">
                                                <option value="0" selected>Operador(a)</option>
                                                <option value="1">Administrador(a)</option>
                                            </select>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                            <div class="form-group text-right m-b-0">
                                <button class="btn btn-primary waves-effect waves-light" onclick="salvar();">
                                    Salvar
                                </button>
                                <button class="btn btn-secondary waves-effect waves-light m-l-5" onclick="cancelaPopup();">
                                    Cancelar
                                </button>
                            </div>

                        </form>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/waves.js"></script>
    <script src="assets/js/jquery.slimscroll.js"></script>

    <script src="assets/js/jquery.core.js"></script>
    <script src="assets/js/jquery.app.js"></script>

    <script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="assets/plugins/datatables/dataTables.bootstrap4.min.js"></script>

    <script src="assets/plugins/datatables/dataTables.buttons.min.js"></script>
    <script src="assets/plugins/datatables/buttons.bootstrap4.min.js"></script>
    <script src="assets/plugins/datatables/jszip.min.js"></script>
    <script src="assets/plugins/datatables/pdfmake.min.js"></script>
    <script src="assets/plugins/datatables/vfs_fonts.js"></script>
    <script src="assets/plugins/datatables/buttons.html5.min.js"></script>
    <script src="assets/plugins/datatables/buttons.print.min.js"></script>

    <script src="assets/plugins/datatables/dataTables.keyTable.min.js"></script>

    <script src="assets/plugins/datatables/dataTables.responsive.min.js"></script>
    <script src="assets/plugins/datatables/responsive.bootstrap4.min.js"></script>

    <script src="assets/plugins/datatables/dataTables.select.min.js"></script>

    <script src="assets/plugins/sweet-alert/sweetalert2.min.js"></script>
    <script src="assets/pages/jquery.sweet-alert.init.js"></script>

    <script src="scripts/util.js"></script>
</body>
</html>

<script type="text/javascript">

    let ID_USUARIO = 0;
    let grid1;
    const keep = '8Kd4KmTesIXTOI8awHuhod1X7ERl3divuinW5b8CSNhcO2kITIwUkJDzZpHgZyXx';

    const columns = ['ID Usuário', 'Nome', 'E-mail', 'Ativo', 'Tipo'];
    const h = window.innerHeight - 290;

    const carregaRegistros = () => {
        const url = '/carregaUsuarios';
        const data = {
            keep: keep
        };

        const success = function (response) {
            const data = eval(response);
            atualizaGrid(data);
        };

        doranAjax(url, data, success);
    };

    const atualizaGrid = (data) => {
        if (grid1) {
            $('#tbUsuario').DataTable().clear().destroy();
            grid1 = undefined;
        }

        grid1 = $('#tbUsuario').DataTable({
            data: data,
            scrollY: h,
            searching: false,
            select: {
                style: 'single'
            },
            language: ptBr
        });

        grid1.on('select', function (e, dt, type, indexes) {
            if (type === 'row') {
                const data1 = grid1.rows(indexes).data()[0];
            }
        });
    };

    const novo = () => {
        $('#divForm').modal();
        resetaFormulario();
    };

    const resetaFormulario = () => {
        ID_USUARIO = 0;
        $('#TXT_NOME_USUARIO').val('');
        $('#TXT_EMAIL_USUARIO').val('');
        $('#TXT_SENHA_USUARIO').val('');
        $('#CB_USUARIO_ATIVO').val('1');
        $('#CB_TIPO_USUARIO').val('1');

        $('#TXT_NOME_USUARIO').focus();
    };

    const edita = (_ID_USUARIO) => {
        ID_USUARIO = _ID_USUARIO;

        const url = '/buscaUsuario';
        const data = { 
            ID_USUARIO: ID_USUARIO, 
            keep: keep 
        };

        const success = function (response) {
            const data1 = eval(response);

            $('#TXT_NOME_USUARIO').val(data1[0].NOME_USUARIO);
            $('#TXT_EMAIL_USUARIO').val(data1[0].EMAIL_USUARIO);
            $('#TXT_SENHA_USUARIO').val(data1[0].SENHA_USUARIO);
            $('#CB_USUARIO_ATIVO').val(data1[0].USUARIO_ATIVO);
            $('#CB_TIPO_USUARIO').val(data1[0].TIPO_USUARIO);

            $('#divForm').modal();

            $('#TXT_NOME_USUARIO').focus();
        }

        doranAjax(url, data, success);
    };

    const salvar = () => {
        event.preventDefault();

        if ($('#TXT_NOME_USUARIO').val().trim() == ''
            || $('#TXT_EMAIL_USUARIO').val().trim() == ''
            || $('#TXT_SENHA_USUARIO').val().trim() == '') {
            MensagemDeErro('Preencha todos os campos');
            return;
        }

        const url = '/salvaUsuario';

        const data = {
            ID_USUARIO: ID_USUARIO,
            NOME_USUARIO: $('#TXT_NOME_USUARIO').val(),
            EMAIL_USUARIO: $('#TXT_EMAIL_USUARIO').val(),
            SENHA_USUARIO: $('#TXT_SENHA_USUARIO').val(),
            USUARIO_ATIVO: $('#CB_USUARIO_ATIVO').val(),
            TIPO_USUARIO: $('#CB_TIPO_USUARIO').val(),
            keep: keep
        };

        const success = function (response) {
            if (parseInt(ID_USUARIO) > 0)
                $('#divForm').modal('hide');

            resetaFormulario();

            carregaRegistros();
        }

        doranAjax(url, data, success);
    };

    const deleta = (_ID_USUARIO) => {
        MensagemDeConfirmacao('Deseja deletar o registro?', function () {
            const url = '/deletaUsuario';

            const data = {
                ID_USUARIO: _ID_USUARIO,
                keep: keep
            };

            const success = function (response) {
                carregaRegistros();
            }

            doranAjax(url, data, success);
        });
    };

    const renovar = () => {
        event.preventDefault();
        carregaRegistros();
    };

    const cancelaPopup = () => {
        event.preventDefault();
        $('#divForm').modal('hide');
    };

    const abre = (url) => {
        document.location = url;
    };

    $(document).ready(function () {

        $('#tbUsuario').css('height', parseInt(h) + 'px');
        carregaRegistros();

        $('form input').keydown(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
            }
        });

        $('#divTop').css('width', (document.body.offsetWidth) + 'px').change();
    });

</script>
